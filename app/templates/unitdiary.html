{% extends 'header.html' %}
{% from 'components/diary_entry.html' import diary_entry %}
{% from 'components/slider_bar.html' import slider_bar %}
{% from 'components/info_card.html' import info_card %}

{% block body %}
<!-- Flash messages (merged from main) -->
{% with messages = get_flashed_messages(category_filter=['error_dashboard']) %}
  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ 'success' if 'success_' in message else 'danger' }}" role="alert">
        {{ message }}
      </div>
    {% endfor %}
  {% endif %}
{% endwith %}

{% if is_shared_view %}
  <h1>Viewing {{ user.username }}'s Diary</h1>
{% else %}
  <h1>Your Unit Diary</h1>
{% endif %}

<div class="summary-container">
  <div class="unit-summary-card">
    <div class="summary-row">
      <div class="summary-section">
        <div class="summary-section faculty-chart-container" data-faculty-data="{{ percent_by_faculty_for_chart }}">
          <h5>Percentage of units taken in each faculty:</h5></div>
        <div style="width: 100%; max-width: 500px; margin: 0 auto;">
          <canvas id="facultyPieChart"></canvas>
        </div>
      </div>
      <div class="summary-section">
        {{info_card("Total credit points", total_credits)}}
       {{info_card("Highest WAM Area: ",highest_wam_area)}}
        {{ info_card("Average difficulty of units taken: ",slider_bar(avg_difficulty, 5, 'Easy', 'Hard')) }}
      </div>
    </div>
  </div>
</div>

<div>
  {% if units_taken %} 
  <h3 class="diary-title">Study Snapshot</h3>
  {% for diary, unit in units_taken %}
  {{ diary_entry( unit.code, unit.title, diary.semester, diary.grade, diary.year) }}
  {% endfor %}
  {% endif %}
</div>


<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Extract unit.id from the server-side variable
    percentByFaculty = JSON.parse('{{ percent_by_faculty|tojson|safe }}');
    console.log(percentByFaculty);

    // Prepare unit.id for Chart.js
    const labels = [];
    const chartData = [];
    const backgroundColors = [
      'rgba(255, 99, 132, 0.8)',
      'rgba(54, 162, 235, 0.8)',
      'rgba(255, 206, 86, 0.8)',
      'rgba(75, 192, 192, 0.8)',
      'rgba(153, 102, 255, 0.8)',
      'rgba(255, 159, 64, 0.8)'
    ];

    // Parse the data from the tuple format
    percentByFaculty.forEach(item => {
      labels.push(item.faculty); // Access the 'faculty' property
      chartData.push(parseFloat(item.percentage)); // Access the 'percentage' property and ensure it's a number
    });
    console.log(labels);
    console.log(chartData);

    // Create the pie chart
    const ctx = document.getElementById('facultyPieChart').getContext('2d');
    const facultyPieChart = new Chart(ctx, {
      type: 'pie',
      data: {
        labels: labels,
        datasets: [{
          data: chartData,
          backgroundColor: backgroundColors.slice(0, labels.length),
          borderColor: 'white',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: {
            position: 'right',
            labels: {
              color: 'black', // Changed to black for better default visibility
              font: {
                size: 12
              }
            }
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                const label = context.label || '';
                const value = context.parsed || 0; // Changed to context.parsed
                return `${label}: ${value.toFixed(1)}%`;
              }
            }
          }
        }
      }
    });
  });
</script>
{% endblock %}

